<%- include('partials/nav') %>

<div class="container py-5">
    
    <div class="mb-4">
        <a href="<%= backLink %>" class="btn btn-outline-secondary rounded-pill px-4">
            ‚¨Ö –ù–∞–∑–∞–¥
        </a>
    </div>

    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card shadow p-4 border-0 mb-4" style="border-radius: 20px;">
                <div class="text-center">
                    <img src="<%= user.avatar_url %>" class="rounded-circle border shadow-sm mb-3" width="120" height="120" style="object-fit: cover;">
                    <h3 class="mb-1 fw-bold"><%= user.username %></h3>
                    <p class="text-muted mb-2"><%= user.email %></p>
                    <span class="badge bg-warning text-dark border px-3 py-2 rounded-pill">
                        <%= user.icon %> <%= user.league_name %>
                    </span>
                    <div class="mt-3 d-flex gap-2 justify-content-center justify-content-md-start">
    
                        <a href="/user/<%= userId %>/certificate" class="btn btn-success btn-sm rounded-pill px-4 shadow-sm fw-bold d-flex align-items-center" target="_blank">
                            <i class="bi bi-award-fill"></i> –û—Ç—Ä–∏–º–∞—Ç–∏ –°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç
                        </a>
                        <a href="/user/<%= userId %>/edit" class="btn btn-outline-primary btn-sm rounded-pill px-4 d-flex align-items-center">
                            <i class="bi bi-pencil"></i> –†–µ–¥–∞–≥—É–≤–∞—Ç–∏
                        </a>

                    </div>
                </div>
                <hr class="my-3">
                <div class="d-flex justify-content-between text-center">
                    <div>
                        <h5 class="fw-bold text-primary mb-0"><%= totalPoints %></h5>
                        <small class="text-muted" style="font-size: 0.75rem;">–í—Å—å–æ–≥–æ XP</small>
                    </div>
                    <div>
                        <h5 class="fw-bold mb-0 text-success"><%= stats.maxStreak %> üî•</h5>
                        <small class="text-muted" style="font-size: 0.75rem;">Max –°—Ç—Ä—ñ–∫</small>
                    </div>
                    <div>
                        <h5 class="fw-bold mb-0"><%= testsCount %></h5>
                        <small class="text-muted" style="font-size: 0.75rem;">–¢–µ—Å—Ç—ñ–≤</small>
                    </div>
                </div>
            </div>

            <div class="card shadow border-0 p-4 mb-4" style="border-radius: 20px;">
                <h5 class="fw-bold mb-4">–ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å (–¶–µ–π —Ç–∏–∂–¥–µ–Ω—å)</h5>
                
                <div class="d-flex justify-content-between align-items-end" style="height: 150px;">
                    <% 
                    const days = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–ù–¥'];
                    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ undefined, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –ø–æ–º–∏–ª–æ–∫
                    const chartData = (typeof activity !== 'undefined' && activity.data) ? activity.data : [0,0,0,0,0,0,0];
                    const chartMax = (typeof activity !== 'undefined' && activity.max) ? activity.max : 10;

                    chartData.forEach((score, i) => { 
                        // –í–∏—Ä–∞—Ö–æ–≤—É—î–º–æ –≤–∏—Å–æ—Ç—É —É –≤—ñ–¥—Å–æ—Ç–∫–∞—Ö
                        let heightPercent = Math.round((score / chartMax) * 100);
                        // –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ –≤–∏—Å–æ—Ç–∞ 4px –¥–ª—è –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó –Ω–∞–≤—ñ—Ç—å –ø—É—Å—Ç–∏—Ö –¥–Ω—ñ–≤
                        let barHeight = score > 0 ? `${heightPercent}%` : '4px';
                        // –ö–æ–ª—ñ—Ä: –∞–∫—Ç–∏–≤–Ω–∏–π (—Å–∏–Ω—ñ–π) –∞–±–æ –ø—É—Å—Ç–∏–π (—Å–≤—ñ—Ç–ª–æ-—Å—ñ—Ä–∏–π)
                        let barColor = score > 0 ? 'background-color: #0d6efd;' : 'background-color: #e9ecef;';
                    %>
                        <div class="text-center d-flex flex-column align-items-center justify-content-end h-100" style="width: 12%;">
                            
                            <div style="height: 20px;" class="mb-1">
                                <% if (score > 0) { %>
                                    <small class="text-primary fw-bold" style="font-size: 0.65rem;"><%= score %></small>
                                <% } %>
                            </div>

                            <div class="w-100 rounded-3" 
                                 style="height: <%= barHeight %>; <%= barColor %> transition: height 0.5s ease;" 
                                 title="<%= score %> XP"></div>
                            
                            <small class="mt-2 text-muted fw-bold" style="font-size: 0.75rem;"><%= days[i] %></small>
                        </div>
                    <% }) %>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="p-3 bg-white shadow-sm rounded-4 border h-100 d-flex align-items-center">
                        <div>
                            <h4 class="fw-bold mb-0 text-success"><%= stats.learnedWords %> <span class="text-muted fs-6">/ <%= stats.totalWords %></span></h4>
                            <small class="text-muted fw-bold">–í–∏–≤—á–µ–Ω–æ —Å–ª—ñ–≤</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="p-3 bg-white shadow-sm rounded-4 border h-100 d-flex align-items-center">
                        <div>
                            <h4 class="fw-bold mb-0 text-info"><%= stats.avgLevel %></h4>
                            <small class="text-muted fw-bold">–°–µ—Ä–µ–¥–Ω—ñ–π —Ä—ñ–≤–µ–Ω—å</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="p-3 bg-white shadow-sm rounded-4 border h-100 d-flex align-items-center">
                        <div>
                            <h5 class="fw-bold mb-0"><%= user.formatted_date %></h5>
                            <small class="text-muted fw-bold">–î–∞—Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –î–æ—Å—è–≥–Ω–µ–Ω–Ω—è -->
            <div class="card shadow border-0 p-4 mb-4" style="border-radius: 20px;">
                <h5 class="fw-bold mb-3">üèÜ –ú–æ—ó –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è</h5>
                <div class="d-flex gap-2 flex-wrap">
                    <% if(achievements.length === 0) { %>
                        <div class="text-muted fst-italic">–©–µ –Ω–µ–º–∞—î –¥–æ—Å—è–≥–Ω–µ–Ω—å...</div>
                    <% } %>
                    <% achievements.forEach(a => { %>
                        <div class="badge bg-light text-dark border p-2 d-flex align-items-center gap-2 rounded-pill px-3">
                            <span class="fs-5"><%= a.icon_url %></span>
                            <span><%= a.name %></span>
                        </div>
                    <% }) %>
                </div>
            </div>

            <div class="card shadow border-0 p-4" style="border-radius: 20px;">
                <div class="row align-items-center mb-4 g-3">
                    <div class="col-md-4">
                        <h5 class="fw-bold mb-0">
                            üìö –°–ª–æ–≤–Ω–∏–∫ 
                            <span class="badge bg-light text-dark border ms-2" id="visible-count"><%= dictionary.length %></span>
                        </h5>
                    </div>
                    
                    <div class="col-md-8">
                        <div class="d-flex gap-2 justify-content-md-end flex-wrap">
                            <input type="text" id="dictSearch" class="form-control form-control-sm" placeholder="üîç –ü–æ—à—É–∫..." style="max-width: 150px;">
                            
                            <select id="dictFilter" class="form-select form-select-sm" style="max-width: 120px;">
                                <option value="all">–í—Å—ñ</option>
                                <option value="learning">–í—á—É</option>
                                <option value="learned">–í–∏–≤—á–µ–Ω—ñ</option>
                            </select>

                            <select id="dictSort" class="form-select form-select-sm" style="max-width: 140px;">
                                <option value="newest">–°–ø–æ—á–∞—Ç–∫—É –Ω–æ–≤—ñ</option>
                                <option value="oldest">–°–ø–æ—á–∞—Ç–∫—É —Å—Ç–∞—Ä—ñ</option>
                                <option value="name_asc">–ó–∞ –Ω–∞–∑–≤–æ—é A-Z</option>
                                <option value="level_desc">–ó–∞ —Ä—ñ–≤–Ω–µ–º –≤–∏–≤—á–µ–Ω–Ω—è ‚¨á</option>
                                <option value="level_asc">–ó–∞ —Ä—ñ–≤–Ω–µ–º –≤–∏–≤—á–µ–Ω–Ω—è ‚¨Ü</option>
                            </select>
                        </div>
                    </div>
                </div>

                <% if(dictionary.length === 0) { %>
                    <div class="alert alert-light text-center py-4 border bg-light rounded-4">
                        <p class="text-muted mb-2">–°–ª–æ–≤–Ω–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π</p>
                        <a href="/user/<%= userId %>/dashboard" class="btn btn-sm btn-primary rounded-pill">–í—á–∏—Ç–∏ —Å–ª–æ–≤–∞</a>
                    </div>
                <% } else { %>
                    <div class="table-responsive rounded-4 border" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-hover bg-white mb-0 align-middle">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th class="ps-4">–°–ª–æ–≤–æ</th>
                                    <th>–ü–µ—Ä–µ–∫–ª–∞–¥</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th class="pe-4">–†—ñ–≤–µ–Ω—å</th>
                                </tr>
                            </thead>
                            <tbody id="dictBody">
                                <% dictionary.forEach(w => { %>
                                <tr class="word-row" 
                                    data-original="<%= w.original.toLowerCase() %>" 
                                    data-translation="<%= w.translation.toLowerCase() %>"
                                    data-status="<%= w.status %>"
                                    data-level="<%= w.repetition_level %>"
                                    data-id="<%= w.id %>">
                                    
                                    <td class="ps-4 fw-bold text-primary"><%= w.original %></td>
                                    <td><%= w.translation %></td>
                                    <td>
                                        <% if(w.status === 'learning') { %><span class="badge bg-primary rounded-pill">–í—á—É</span><% } %>
                                        <% if(w.status === 'learned') { %><span class="badge bg-success rounded-pill">–í–∏–≤—á–µ–Ω–æ</span><% } %>
                                        <% if(w.status === 'new') { %><span class="badge bg-secondary rounded-pill">–ù–æ–≤–µ</span><% } %>
                                    </td>
                                    <td class="pe-4" style="min-width: 120px;">
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="progress flex-grow-1" style="height: 6px;">
                                                <div class="progress-bar bg-success" style="width: <%= Math.min(w.repetition_level * 20, 100) %>%"></div>
                                            </div>
                                            <small class="text-muted fw-bold" style="width: 20px;"><%= w.repetition_level %></small>
                                        </div>
                                    </td>
                                </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                    <div id="noResults" class="text-center py-4 d-none text-muted">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>
                <% } %>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('dictSearch');
        const filterSelect = document.getElementById('dictFilter');
        const sortSelect = document.getElementById('dictSort');
        const tableBody = document.getElementById('dictBody');
        const noResults = document.getElementById('noResults');
        const countBadge = document.getElementById('visible-count');
        
        if (!tableBody) return;

        let rows = Array.from(document.querySelectorAll('.word-row'));

        function updateTable() {
            const term = searchInput.value.toLowerCase();
            const filter = filterSelect.value;
            const sort = sortSelect.value;
            
            let visibleRows = rows.filter(row => {
                const original = row.dataset.original;
                const translation = row.dataset.translation;
                const status = row.dataset.status;
                const matchesSearch = original.includes(term) || translation.includes(term);
                const matchesFilter = (filter === 'all') || (filter === status);
                return matchesSearch && matchesFilter;
            });

            visibleRows.sort((a, b) => {
                if (sort === 'name_asc') return a.dataset.original.localeCompare(b.dataset.original);
                if (sort === 'level_desc') return parseInt(b.dataset.level) - parseInt(a.dataset.level);
                if (sort === 'level_asc') return parseInt(a.dataset.level) - parseInt(b.dataset.level);
                if (sort === 'newest') return parseInt(b.dataset.id) - parseInt(a.dataset.id);
                if (sort === 'oldest') return parseInt(a.dataset.id) - parseInt(b.dataset.id);
                return 0;
            });

            tableBody.innerHTML = '';
            visibleRows.forEach(row => tableBody.appendChild(row));
            countBadge.innerText = visibleRows.length;
            
            if (visibleRows.length === 0) {
                noResults.classList.remove('d-none');
                tableBody.parentElement.classList.add('d-none');
            } else {
                noResults.classList.add('d-none');
                tableBody.parentElement.classList.remove('d-none');
            }
        }

        searchInput.addEventListener('input', updateTable);
        filterSelect.addEventListener('change', updateTable);
        sortSelect.addEventListener('change', updateTable);
    });
</script>