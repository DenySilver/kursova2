<%- include('../partials/nav') %>
<div class="container py-5 text-center">
    <h2 class="mb-4"><%= title %></h2>

    <% if(words.length === 0) { %>
        <div class="alert alert-success mt-5">
            <h3>üéâ –°–ø–∏—Å–æ–∫ –ø—É—Å—Ç–∏–π!</h3>
            <p>–ù–µ–º–∞—î —Å–ª—ñ–≤ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≤ —Ü—å–æ–º—É —Ä–µ–∂–∏–º—ñ.</p>
            <a href="/dashboard" class="btn btn-primary">–ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
        </div>
    <% } else { %>
        <!-- –ü—Ä–æ–≥—Ä–µ—Å -->
        <p class="text-muted">–ö–∞—Ä—Ç–∫–∞ <span id="current-index">1</span> –∑ <%= words.length %></p>
        
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞—Ä—Ç–æ–∫ -->
        <div class="d-flex justify-content-center mb-4">
            <div id="card-area" class="flip-card w-100" style="max-width: 400px;" onclick="flipCard()">
                <div class="flip-card-inner" id="card-inner">
                    <!-- –ü–µ—Ä–µ–¥–Ω—è —á–∞—Å—Ç–∏–Ω–∞ -->
                    <div class="flip-card-front">
                        <img id="word-image" src="" height="80" class="mb-3 d-none">
                        <h1 class="display-4 fw-bold" id="word-original"></h1>
                        <p class="text-muted small">–ù–∞—Ç–∏—Å–Ω–∏, —â–æ–± –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∏</p>
                    </div>
                    <!-- –ó–∞–¥–Ω—è —á–∞—Å—Ç–∏–Ω–∞ -->
                    <div class="flip-card-back">
                        <h1 class="text-success" id="word-translation"></h1>
                        <p class="fst-italic" id="word-context">Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è -->
        <div id="controls-area" class="d-flex justify-content-center gap-3">
            <% if(mode === 'repetition') { %>
                <!-- –†–µ–∂–∏–º –ø–æ–≤—Ç–æ—Ä–µ–Ω–Ω—è: –û—Ü—ñ–Ω—é—î–º–æ —Å–µ–±–µ -->
                <button class="btn btn-danger px-4 py-2" onclick="processRepetition('no')">–ù–µ –∑–Ω–∞—é üòû</button>
                <button class="btn btn-success px-4 py-2" onclick="processRepetition('yes')">–ó–Ω–∞—é! üòé</button>
            <% } else { %>
                <!-- –†–µ–∂–∏–º –ø–µ—Ä–µ–≥–ª—è–¥—É: –ì–æ—Ä—Ç–∞—î–º–æ -->
                <button class="btn btn-secondary px-4" onclick="prevCard()">‚¨Ö –ù–∞–∑–∞–¥</button>
                <button class="btn btn-primary px-4" onclick="nextCard()">–î–∞–ª—ñ ‚û°</button>
            <% } %>
        </div>

        <!-- –°–∫—Ä–∏–ø—Ç –ª–æ–≥—ñ–∫–∏ –∫–∞—Ä—Ç–æ–∫ -->
        <script>
            // –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –∑ —Å–µ—Ä–≤–µ—Ä–∞ —è–∫ JSON
            const words = <%- JSON.stringify(words) %>;
            const mode = "<%= mode %>";
            let currentIndex = 0;

            // –§—É–Ω–∫—Ü—ñ—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ—ó –∫–∞—Ä—Ç–∫–∏
            function renderCard() {
                if (currentIndex >= words.length) {
                    document.querySelector('.container').innerHTML = `
                        <div class="alert alert-success mt-5">
                            <h3>üéâ –í–∏ –ø—Ä–æ–π—à–ª–∏ –≤—Å—ñ –∫–∞—Ä—Ç–∫–∏!</h3>
                            <a href="/dashboard" class="btn btn-primary mt-3">–ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
                        </div>
                    `;
                    return;
                }

                const word = words[currentIndex];
                const cardInner = document.getElementById('card-inner');
                
                // –°–∫–∏–¥–∞—î–º–æ –ø–æ–≤–æ—Ä–æ—Ç –∫–∞—Ä—Ç–∫–∏
                document.getElementById('card-area').classList.remove('flipped');

                // –ó–∞–ø–æ–≤–Ω—é—î–º–æ –¥–∞–Ω–∏–º–∏ (–∑ –Ω–µ–≤–µ–ª–∏–∫–æ—é –∑–∞—Ç—Ä–∏–º–∫–æ—é, —â–æ–± –Ω–µ –≤–∏–¥–Ω–æ –±—É–ª–æ –ø—ñ–¥–º—ñ–Ω–∏ –ø—ñ–¥ —á–∞—Å –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç—É)
                setTimeout(() => {
                    document.getElementById('word-original').innerText = word.original;
                    document.getElementById('word-translation').innerText = word.translation;
                    document.getElementById('current-index').innerText = currentIndex + 1;

                    // –ö–∞—Ä—Ç–∏–Ω–∫–∞ (—è–∫—â–æ —î)
                    const img = document.getElementById('word-image');
                    if (word.image_url && word.image_url !== 'null') {
                        img.src = word.image_url;
                        img.classList.remove('d-none');
                    } else {
                        img.classList.add('d-none');
                    }
                }, 200);
            }

            // –ü–µ—Ä–µ–≤–æ—Ä–æ—Ç –∫–∞—Ä—Ç–∫–∏
            function flipCard() {
                document.getElementById('card-area').classList.toggle('flipped');
            }

            // --- –õ–æ–≥—ñ–∫–∞ –¥–ª—è "–§–ª–µ—à-–∫–∞—Ä—Ç–æ–∫" ---
            function nextCard() {
                if (currentIndex < words.length - 1) {
                    currentIndex++;
                    renderCard();
                } else {
                    alert("–¶–µ –æ—Å—Ç–∞–Ω–Ω—è –∫–∞—Ä—Ç–∫–∞!");
                }
            }

            function prevCard() {
                if (currentIndex > 0) {
                    currentIndex--;
                    renderCard();
                }
            }

            // --- –õ–æ–≥—ñ–∫–∞ –¥–ª—è "–Ü–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–≥–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–Ω—è" (AJAX) ---
            function processRepetition(result) {
                const word = words[currentIndex];
                
                // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                fetch('/study/process', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        record_id: word.record_id, // ID –∑–∞–ø–∏—Å—É –≤ —Å–ª–æ–≤–Ω–∏–∫—É
                        is_correct: result
                    })
                })
                .then(res => res.json())
                .then(data => {
                    // –ü–æ–∫–∞–∑—É—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–±–∞–ª–∏) —ñ –ø–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–∞–ª—ñ
                    console.log(`Earned: ${data.points_earned} XP`);
                    currentIndex++;
                    renderCard();
                })
                .catch(err => console.error(err));
            }

            // –ó–∞–ø—É—Å–∫ –ø–µ—Ä—à–æ—ó –∫–∞—Ä—Ç–∫–∏
            renderCard();
        </script>
    <% } %>
</div>
</body>
</html>