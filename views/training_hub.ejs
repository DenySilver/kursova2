<%- include('partials/nav') %>

<div class="container py-5">
    <div class="row">
        
        <div class="col-lg-9">
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="mb-0 fw-bold">–í–∏–≤—á–µ–Ω–Ω—è: <%= lang.language_name %></h1>
                    <p class="text-muted">–û–±–µ—Ä–∏ —Ä–µ–∂–∏–º —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è –∞–±–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</p>
                </div>
                <a href="/user/<%= userId %>/dashboard" class="btn btn-outline-secondary">‚¨Ö –Ü–Ω—à—ñ –º–æ–≤–∏</a>
            </div>

            <div class="row g-3 mb-5">
                <div class="col-md-4">
                    <div class="card bg-primary text-white shadow h-100 border-0 overflow-hidden position-relative">
                        <div class="card-body p-4 position-relative" style="z-index: 2;">
                            <h4 class="mb-2">üß† –ü–æ–≤—Ç–æ—Ä–µ–Ω–Ω—è</h4>
                            <% if (typeof repetitionCount !== 'undefined' && repetitionCount > 0) { %>
                                <span class="badge bg-white text-primary mb-2"><%= repetitionCount %> —Å–ª—ñ–≤</span>
                            <% } else { %>
                                <small class="opacity-75 d-block mb-3">–ù–µ–º–∞—î —Å–ª—ñ–≤</small>
                            <% } %>
                            <a href="/study/user/<%= userId %>/repetition/<%= lang.language_id %>" class="btn btn-sm btn-light text-primary fw-bold w-100 stretched-link">–ü–æ—á–∞—Ç–∏</a>
                        </div>
                        <div class="position-absolute top-0 end-0 bg-white opacity-10 rounded-circle" style="width: 150px; height: 150px; margin-top: -30px; margin-right: -30px;"></div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card bg-danger text-white shadow h-100 border-0 overflow-hidden position-relative">
                        <div class="card-body p-4 position-relative" style="z-index: 2;">
                            <h4 class="mb-2">üî• –°–ø—Ä–∏–Ω—Ç</h4>
                            <p class="small opacity-75 mb-3">60 —Å–µ–∫—É–Ω–¥. –ü–µ—Ä–µ–≤—ñ—Ä —Å–≤–æ—é —Ä–µ–∞–∫—Ü—ñ—é!</p>
                            <a href="/study/user/<%= userId %>/sprint/<%= lang.language_id %>" class="btn btn-sm btn-light text-danger fw-bold w-100 stretched-link">–ì—Ä–∞—Ç–∏</a>
                        </div>
                        <div class="position-absolute top-0 end-0 bg-white opacity-10 rounded-circle" style="width: 150px; height: 150px; margin-top: -30px; margin-right: -30px;"></div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card bg-warning text-dark shadow h-100 border-0 overflow-hidden position-relative">
                        <div class="card-body p-4 position-relative" style="z-index: 2;">
                            <h4 class="mb-2">üìù –¢–µ—Å—Ç</h4>
                            <p class="small opacity-75 mb-3">5 –∑–∞–ø–∏—Ç–∞–Ω—å –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∑–Ω–∞–Ω—å.</p>
                            <a href="/study/user/<%= userId %>/test/<%= lang.language_id %>" class="btn btn-sm btn-dark fw-bold w-100 stretched-link">–ü—Ä–æ–π—Ç–∏</a>
                        </div>
                        <div class="position-absolute top-0 end-0 bg-white opacity-10 rounded-circle" style="width: 150px; height: 150px; margin-top: -30px; margin-right: -30px;"></div>
                    </div>
                </div>
            </div>

            <div class="row align-items-center mb-4 g-3">
                <div class="col-md-3">
                    <h3 class="mb-0 fw-bold text-nowrap">üìÇ –ö–∞—Ç–∞–ª–æ–≥</h3>
                </div>
                <div class="col-md-9">
                    <div class="d-flex gap-2 justify-content-md-end">
                        <input type="text" id="searchInput" class="form-control" placeholder="üîç –ü–æ—à—É–∫..." style="max-width: 200px;" oninput="updateGrid()">
                        
                        <select id="sortSelect" class="form-select" style="max-width: 180px;" onchange="updateGrid()">
                            <option value="name">–ó–∞ –Ω–∞–∑–≤–æ—é A-Z</option>
                            <option value="progress">–ü—Ä–æ–≥—Ä–µ—Å (Max)</option>
                            <option value="count">–ó–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—é —Å–ª—ñ–≤</option>
                            <option value="difficulty_asc">–°–ø–æ—á–∞—Ç–∫—É –ª–µ–≥–∫—ñ</option>
                            <option value="difficulty_desc">–°–ø–æ—á–∞—Ç–∫—É –≤–∞–∂–∫—ñ</option>
                        </select>

                        <select id="filterSelect" class="form-select" style="max-width: 180px;" onchange="updateGrid()">
                            <option value="all">–í—Å—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</option>
                            <option value="completed">–¢—ñ–ª—å–∫–∏ –≤–∏–≤—á–µ–Ω—ñ</option>
                            <option value="in_progress">–í –ø—Ä–æ—Ü–µ—Å—ñ</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="row g-4" id="categoriesContainer">
            </div>
            
            <div id="noResults" class="text-center py-5 d-none">
                <h4 class="text-muted">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ üòû</h4>
            </div>

        </div>

        <%- include('partials/sidebar') %>

    </div>
</div>

<script>
    const categoriesData = <%- JSON.stringify(categories) %>;
    const userId = "<%= userId %>";
    const langId = "<%= lang.language_id %>";

    function createCardHTML(cat) {
        let borderClass = 'border-success'; 
        let bgBadge = 'bg-success';

        if (cat.difficulty_level === 'Medium') { 
            borderClass = 'border-warning'; 
            bgBadge = 'bg-warning text-dark'; 
        } else if (cat.difficulty_level === 'Hard') { 
            borderClass = 'border-danger'; 
            bgBadge = 'bg-danger'; 
        }

        const link = `/study/user/${userId}/cards/${langId}/cat/${cat.category_id}`;

        let progressHTML = '';
        let progressColor = 'bg-primary';
        if (cat.progress === 100) progressColor = 'bg-success';

        let btnText = "–í—á–∏—Ç–∏ –∫–∞—Ä—Ç–∫–∏ ‚ûî";
        let btnClass = "btn-outline-dark";
        if (cat.progress === 100) {
            btnText = "–ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ (–í–∏–≤—á–µ–Ω–æ) ‚Ü∫";
            btnClass = "btn-success text-white";
        }

        return `
            <div class="col-md-4 col-sm-6 animate-fade-in">
                <div class="card h-100 shadow-sm hover-lift border-top border-4 ${borderClass}">
                    <div class="card-body p-4 d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h4 class="card-title fw-bold mb-0 text-truncate" title="${cat.category_name}">${cat.category_name}</h4>
                            <span class="badge ${bgBadge} rounded-pill">${cat.difficulty_level}</span>
                        </div>
                        
                        <div class="d-flex justify-content-between small text-muted mb-1">
                            <span>${cat.learned_words || 0} / ${cat.total_words || 0} —Å–ª—ñ–≤</span>
                            <span class="fw-bold">${cat.progress}%</span>
                        </div>

                        <div class="progress mb-4" style="height: 8px;">
                            <div class="progress-bar ${progressColor}" role="progressbar" style="width: ${cat.progress}%"></div>
                        </div>

                        <a href="${link}" class="btn ${btnClass} w-100 mt-auto rounded-pill fw-bold stretched-link">
                           ${btnText}
                        </a>
                    </div>
                </div>
            </div>
        `;
    }

    function getDifficultyVal(level) {
        if (level === 'Easy') return 1;
        if (level === 'Medium') return 2;
        if (level === 'Hard') return 3;
        return 0;
    }

    function updateGrid() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const sortType = document.getElementById('sortSelect').value;
        const filterType = document.getElementById('filterSelect').value;
        const container = document.getElementById('categoriesContainer');
        const noResults = document.getElementById('noResults');

        let filtered = categoriesData.filter(cat => {
            const matchesSearch = cat.category_name.toLowerCase().includes(searchTerm);
            let matchesFilter = true;

            if (filterType === 'completed') matchesFilter = (cat.progress === 100);
            if (filterType === 'in_progress') matchesFilter = (cat.progress < 100);

            return matchesSearch && matchesFilter;
        });

        filtered.sort((a, b) => {
            if (sortType === 'name') return a.category_name.localeCompare(b.category_name);
            if (sortType === 'count') return b.total_words - a.total_words;
            if (sortType === 'progress') return b.progress - a.progress;
            if (sortType === 'difficulty_asc') return getDifficultyVal(a.difficulty_level) - getDifficultyVal(b.difficulty_level);
            if (sortType === 'difficulty_desc') return getDifficultyVal(b.difficulty_level) - getDifficultyVal(a.difficulty_level);
        });

        container.innerHTML = filtered.map(cat => createCardHTML(cat)).join('');
        
        if (filtered.length === 0) {
            noResults.classList.remove('d-none');
        } else {
            noResults.classList.add('d-none');
        }
    }

    document.addEventListener('DOMContentLoaded', updateGrid);
</script>

<style>
    .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .hover-lift { transition: transform 0.2s, box-shadow 0.2s; }
    .hover-lift:hover { transform: translateY(-5px); box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important; }
    
    .opacity-10 { opacity: 0.1; }
    .opacity-25 { opacity: 0.25; }
    .opacity-75 { opacity: 0.75; }
    
    .animate-pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
</style>